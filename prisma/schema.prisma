// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  CASHIER
  MANAGER
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  PAYMENT_GATEWAY
}

enum StockLogType {
  INCOMING
  SALES
  WASTE
  ADJUSTMENT
}

model AppSetting {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  value       String
  description String?

  @@map("app_settings")
}

model Supplier {
  id   Int    @id @default(autoincrement())
  name String @unique

  @@map("suppliers")
}

model IngredientCategory {
  id   Int    @id @default(autoincrement())
  name String @unique

  ingredients Ingredient[]

  @@map("ingredient_categories")
}

model Ingredient {
  id           Int     @id @default(autoincrement())
  name         String  @unique
  stock        Float   @default(0)
  minStock     Float   @default(0) @map("min_stock")
  cost         Int
  unit         String
  discontinued Boolean @default(false)

  ingredientCategoryId Int                @map("ingredient_category_id")
  ingredientCategory   IngredientCategory @relation(fields: [ingredientCategoryId], references: [id], onDelete: Restrict)

  stockLogs       StockLog[]
  menuIngredients MenuIngredient[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ingredients")
}

model MenuCategory {
  id   Int    @id @default(autoincrement())
  name String @unique

  menus Menu[]

  @@map("menu_categories")
}

model Menu {
  id          Int     @id @default(autoincrement())
  name        String
  description String? @db.Text
  price       Decimal @db.Decimal(12, 2)
  imageUrl    String? @map("image_url")
  isActive    Boolean @default(true) @map("is_active")

  menuCategoryId Int          @map("menu_category_id")
  menuCategory   MenuCategory @relation(fields: [menuCategoryId], references: [id], onDelete: Restrict)

  ingredients MenuIngredient[]

  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")
  orderItems OrderItem[]

  @@map("menus")
}

model MenuIngredient {
  id Int @id @default(autoincrement())

  menu   Menu @relation(fields: [menuId], references: [id], onDelete: Cascade)
  menuId Int  @map("menu_id")

  ingredientId Int        @map("ingredient_id")
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  quantityNeeded Float @map("quantity_needed")

  @@map("menu_ingredients")
}

model User {
  id       Int      @id @default(autoincrement())
  name     String
  email    String?  @unique
  password String
  role     UserRole

  cashierShifts CashierShift[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Customer {
  id          Int     @id @default(autoincrement())
  name        String
  phone       String? @unique
  email       String?
  address     String? @db.Text
  totalPoints Int     @default(0) @map("total_points")

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("customers")
}

model CashierShift {
  id Int @id @default(autoincrement())

  userId Int  @map("user_id")
  user   User @relation(fields: [userId], references: [id])

  startTime DateTime  @default(now()) @map("start_time")
  endTime   DateTime? @map("end_time")

  startCash Decimal @map("start_cash") @db.Decimal(12, 2)

  expectedCash Decimal? @map("expected_cash") @db.Decimal(12, 2)
  actualCash   Decimal? @map("actual_cash") @db.Decimal(12, 2)
  difference   Decimal? @db.Decimal(12, 2)

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("cashier_shifts")
}

model Order {
  id            Int         @id @default(autoincrement())
  invoiceNumber String      @unique @map("invoice_number")
  status        OrderStatus @default(PENDING)
  note          String?     @db.Text
  subtotal      Decimal     @db.Decimal(15, 2)
  taxAmount     Decimal     @default(0) @map("tax_amount") @db.Decimal(15, 2)
  grandTotal    Decimal     @map("grand_total") @db.Decimal(15, 2)
  totalCost     Decimal     @default(0) @map("total_cost") @db.Decimal(15, 2)
  netProfit     Decimal     @default(0) @map("net_profit") @db.Decimal(15, 2)

  cashierShiftId Int?          @map("cashier_shift_id")
  cashierShift   CashierShift? @relation(fields: [cashierShiftId], references: [id])

  customerId Int?      @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])

  items   OrderItem[]
  payment Payment?
  stockLogs StockLog[]

  paidAt    DateTime?  @map("paid_at")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id Int @id @default(autoincrement())

  quantity      Int
  note          String?
  snapshotPrice Decimal @map("snapshot_price") @db.Decimal(15, 2)
  snapshotCost  Decimal @map("snapshot_cost") @db.Decimal(15, 2)
  itemProfit    Decimal @map("item_profit") @db.Decimal(15, 2)

  orderId Int   @map("order_id")
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  menuId Int  @map("menu_id")
  menu   Menu @relation(fields: [menuId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

model Payment {
  id      Int   @id @default(autoincrement())
  orderId Int   @unique @map("order_id")
  order   Order @relation(fields: [orderId], references: [id])

  method     PaymentMethod
  amountPaid Decimal       @map("amount_paid") @db.Decimal(15, 2)

  changeAmount Decimal @default(0) @map("change_amount") @db.Decimal(15, 2)

  transferProofUrl String? @map("transfer_proof_url")
  bankName         String?

  midtransSnapToken String? @map("midtrans_snap_token")
  midtransTrxId     String? @map("midtrans_trx_id")
  midtransStatus    String?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("payments")
}

model StockLog {
  id       Int          @id @default(autoincrement())
  quantity Float
  type     StockLogType @default(SALES)
  note     String?

  createdAt DateTime @default(now()) @map("created_at")

  ingredientId Int        @map("ingredient_id")
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  orderId Int?   @map("order_id")
  order   Order? @relation(fields: [orderId], references: [id])

  @@map("stock_logs")
}
